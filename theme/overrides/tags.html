{# overrides/tags.html #}
{% extends "main.html" %}

{% macro tag_slug(tag) -%}
{{- tag|string|lower
      |replace(' ', '-')
      |replace('/', '-')
      |replace('&', 'and') -}}
{%- endmacro %}

{% block content %}
  <h1>分类</h1>

  {# Build tag -> [pages] map from site nav #}
  {% set ns = namespace(tag_map={}) %}
  {% for p in nav.pages %}
    {% if p.meta and p.meta.tags %}
      {% for t in p.meta.tags %}
        {% set tag = t|string %}
        {% set _ = (ns.tag_map.setdefault(tag, [])).append(p) %}
      {% endfor %}
    {% endif %}
  {% endfor %}

  {% if ns.tag_map %}
    {# -------- TOC (list of tags) -------- #}
    {% set tag_items = ns.tag_map|dictsort(case_sensitive=False) %}
    <nav class="tags-toc" aria-label="Tags table of contents">
      <strong class="tags-toc__title">所有分类</strong>
        {% for tag, pages in tag_items %}
          <a href="#{{ tag_slug(tag) }}" class="tag-pill">{{ tag }}<span class="tags-toc__count">{{ pages|length }}</span></a>
          
        {% endfor %}
    </nav>

    {# -------- Full sections -------- #}
    {% for tag, pages in tag_items %}
      <h2 id="{{ tag_slug(tag) }}">{{ tag }} ({{ pages|length }})</h2>
      <ul>
        {% for p in pages|sort(attribute='title') %}
          <li><a href="{{ p.url | url }}">{{ p.title or p.file.src_path }}</a></li>
        {% endfor %}
      </ul>
    {% endfor %}
  {% else %}
    <p><em>No tagged pages yet. Add <code>tags:</code> in your pages' front matter.</em></p>
  {% endif %}
{% endblock %}

{% block styles %}
  {{ super() }}
  <style>
    .tags-toc { margin: .75rem 0 1.25rem; }
    .tags-toc__title { display: block; margin-bottom: .25rem; opacity: .75; }
    .tags-toc__list {
      display: flex; flex-wrap: wrap; gap: .35rem .5rem;
      list-style: none; padding: 0; margin: 0;
    }
    .tags-toc__item { font-size: .95em; }
    .tags-toc__item a { text-decoration: none; }
    .tags-toc__count {
      margin-left: .35rem; font-size: .85em; opacity: .65;
    }
  </style>
{% endblock %}
